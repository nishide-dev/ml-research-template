name: Test Template

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test-generation:
    name: Test Template Generation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        package-manager: ["uv", "pixi"]
        pytorch-preset: ["pytorch-2.8.0-cuda-12.6", "pytorch-2.9.0-cuda-12.6"]

    steps:
      - name: Checkout template
        uses: actions/checkout@v4

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Test template generation
        run: |
          uvx copier copy --trust \
            --data project_name="test-ml-project" \
            --data package_name="test_ml_project" \
            --data description="Test ML project" \
            --data author_name="Test Author" \
            --data author_email="test@example.com" \
            --data python_version="${{ matrix.python-version }}" \
            --data package_manager="${{ matrix.package-manager }}" \
            --data pytorch_cuda_preset="${{ matrix.pytorch-preset }}" \
            --data use_ruff=true \
            --data use_ty=true \
            --data use_pytest=true \
            --data use_github_actions=true \
            --data use_nix=false \
            --data use_lightning=true \
            --data lightning_version="2.4" \
            --data use_hydra=true \
            --data hydra_version="1.3" \
            --data use_pytorch_geometric=false \
            --data logger_choice="tensorboard" \
            --data template_type="minimal" \
            . /tmp/test-project

      - name: Verify generated project structure
        working-directory: /tmp/test-project
        run: |
          # Check critical files exist
          test -f pyproject.toml
          test -f README.md
          test -f .gitignore
          test -d src/test_ml_project
          test -d configs
          test -f src/test_ml_project/train.py
          test -f src/test_ml_project/models/base_model.py
          test -f src/test_ml_project/data/datamodule.py
          test -d tests

      - name: Verify dependencies (uv)
        if: matrix.package-manager == 'uv'
        working-directory: /tmp/test-project
        run: |
          uv sync
          uv run python -c "import torch; print(f'PyTorch: {torch.__version__}')"
          uv run python -c "import lightning; print(f'Lightning: {lightning.__version__}')"
          uv run python -c "import hydra; print(f'Hydra: {hydra.__version__}')"

      - name: Run quality checks (uv)
        if: matrix.package-manager == 'uv'
        working-directory: /tmp/test-project
        run: |
          uv run ruff check . || true
          uv run ruff format --check . || true
          uv run pytest tests/ || true

      - name: Install pixi
        if: matrix.package-manager == 'pixi'
        run: curl -fsSL https://pixi.sh/install.sh | bash

      - name: Add pixi to PATH
        if: matrix.package-manager == 'pixi'
        run: echo "$HOME/.pixi/bin" >> $GITHUB_PATH

      - name: Verify dependencies (pixi)
        if: matrix.package-manager == 'pixi'
        working-directory: /tmp/test-project
        run: |
          pixi install
          pixi run python -c "import torch; print(f'PyTorch: {torch.__version__}')"
          pixi run python -c "import lightning; print(f'Lightning: {lightning.__version__}')"
          pixi run python -c "import hydra; print(f'Hydra: {hydra.__version__}')"

      - name: Run quality checks (pixi)
        if: matrix.package-manager == 'pixi'
        working-directory: /tmp/test-project
        run: |
          pixi run ruff check . || true
          pixi run ruff format --check . || true
          pixi run pytest tests/ || true
