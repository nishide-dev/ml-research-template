# pixi.toml - Optimized ML package management with Conda + PyPI
# Generated from ML Research Copier template
#
# Architecture:
# - Python: conda (base environment)
# - PyTorch & ML packages: PyPI (faster, latest versions, bundled CUDA)
# - Complex dependencies: conda (if needed)
#
# Pixi v1.0+ supports [pypi-dependencies] for hybrid conda+PyPI usage

{# Extract PyTorch/CUDA versions from preset #}
{% if pytorch_cuda_preset == 'pytorch-2.9.0-cuda-12.6' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '12.6' %}
  {% set cuda_suffix = 'cu126' %}
{% elif pytorch_cuda_preset == 'pytorch-2.9.0-cuda-13.0' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '13.0' %}
  {% set cuda_suffix = 'cu130' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.6' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.6' %}
  {% set cuda_suffix = 'cu126' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.8' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.8' %}
  {% set cuda_suffix = 'cu128' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-12.6' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '12.6' %}
  {% set cuda_suffix = 'cu126' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-11.8' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '11.8' %}
  {% set cuda_suffix = 'cu118' %}
{% elif pytorch_cuda_preset == 'pytorch-2.6.0-cuda-12.4' %}
  {% set pytorch_version = '2.6.0' %}
  {% set cuda_version = '12.4' %}
  {% set cuda_suffix = 'cu124' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-12.1' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '12.1' %}
  {% set cuda_suffix = 'cu121' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-11.8' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '11.8' %}
  {% set cuda_suffix = 'cu118' %}
{# else: use custom values from user input #}
{% endif %}

[workspace]
name = "{{ project_name }}"
version = "0.1.0"
description = "{{ description }}"
channels = ["conda-forge"]  # PyTorch comes from PyPI
platforms = ["linux-64", "osx-arm64"]  # PyTorch 2.5+ only supports ARM on macOS

[dependencies]
# Base Python from conda for consistent environment
python = "{{ python_version }}.*"

[pypi-dependencies]
# Local package in editable mode
{{ project_name }} = { path = ".", editable = true }
# PyTorch from PyPI (includes bundled CUDA, faster installation)
torch = "=={{ pytorch_version }}"
{% if use_torchvision -%}
torchvision = "*"
{% endif -%}
{% if use_torchaudio -%}
torchaudio = "*"
{% endif -%}
{% if use_lightning -%}
pytorch-lightning = ">={{ lightning_version }}"
rich = ">=10.2.2"  # Required for RichProgressBar
{% endif -%}
{% if use_hydra -%}
hydra-core = ">={{ hydra_version }}"
{% endif -%}
{% if logger_choice == 'tensorboard' or logger_choice == 'both' -%}
tensorboard = ">=2.15"
{% endif -%}
{% if logger_choice == 'wandb' or logger_choice == 'both' -%}
wandb = ">=0.16"
{% endif -%}
{% if logger_choice == 'mlflow' -%}
mlflow = ">=2.9"
{% endif -%}
# Core scientific packages
numpy = ">=1.24"
matplotlib = "*"
scikit-learn = "*"

{% if use_pytorch_geometric -%}
[feature.pyg.pypi-dependencies]
# PyTorch Geometric and extensions from PyPI
torch-geometric = "*"
torch-scatter = "*"
torch-sparse = "*"
torch-cluster = "*"

{% endif -%}
[feature.dev.pypi-dependencies]
# Development tools from PyPI
{% if use_pytest -%}
pytest = ">=8.0"
pytest-cov = ">=4.1"
{% endif -%}
{% if use_ruff -%}
ruff = ">=0.6"
{% endif -%}
{% if use_ty -%}
ty = "*"
{% endif -%}

[tasks]
{% if use_hydra -%}
train = "python src/{{ package_name }}/train.py"
train-cpu = "python src/{{ package_name }}/train.py trainer.accelerator=cpu"
train-gpu = "python src/{{ package_name }}/train.py trainer.accelerator=gpu"
train-debug = "python src/{{ package_name }}/train.py trainer.fast_dev_run=true"
{% else -%}
train = "python src/{{ package_name }}/train.py"
{% endif -%}
{% if logger_choice == 'tensorboard' or logger_choice == 'both' -%}
tensorboard = "tensorboard --logdir logs/"
{% endif -%}
{% if use_pytest -%}
test = "pytest tests/ -v"
test-cov = "pytest tests/ -v --cov=src/{{ package_name }} --cov-report=term-missing"
{% endif -%}
{% if use_ruff -%}
lint = "ruff check src/ tests/"
format = "ruff format src/ tests/"
format-check = "ruff format --check src/ tests/"
{% endif -%}
{% if use_ty -%}
typecheck = "ty check"
{% endif -%}

[environments]
default = [
{%- if use_pytorch_geometric %}"pyg", {% endif -%}
"dev"]
prod = []

# Installation notes:
# - Run: pixi install
# - Train: pixi run train
# - Test: pixi run test
# - PyTorch will use bundled CUDA ({{ cuda_suffix }})
